openapi: 3.0.3
info:
  title: micro-dp API
  version: 1.0.0
  description: |
    Contract-first API specification for micro-dp.
servers:
  - url: http://localhost:8080
tags:
  - name: health
  - name: auth
  - name: events
  - name: admin
  - name: plans
  - name: usage
  - name: jobs
  - name: job_runs
  - name: module_types
  - name: connections
  - name: datasets
  - name: uploads
  - name: members
paths:
  /healthz:
    get:
      tags: [health]
      summary: Health check
      operationId: getHealthz
      responses:
        "200":
          description: Health status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
  /api/v1/auth/register:
    post:
      tags: [auth]
      summary: Register user
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/auth/login:
    post:
      tags: [auth]
      summary: Login
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Logged in
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/auth/me:
    get:
      tags: [auth]
      summary: Current user profile
      operationId: me
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Current user profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/auth/google/start:
    get:
      tags: [auth]
      summary: Start Google OAuth login
      operationId: startGoogleOAuth
      responses:
        "302":
          description: Redirect to Google OAuth consent page
          headers:
            Location:
              schema:
                type: string
                format: uri
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/auth/google/callback:
    get:
      tags: [auth]
      summary: Handle Google OAuth callback
      operationId: callbackGoogleOAuth
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
        - name: state
          in: query
          required: true
          schema:
            type: string
      responses:
        "302":
          description: Redirect to app after login attempt
          headers:
            Location:
              schema:
                type: string
                format: uri
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Events ----
  /api/v1/events:
    post:
      tags: [events]
      summary: Ingest event
      operationId: ingestEvent
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestEventRequest"
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestEventResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "402":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"

  /api/v1/events/summary:
    get:
      tags: [events]
      summary: Event counts summary
      operationId: getEventsSummary
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      responses:
        "200":
          description: Event counts summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventsSummaryResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Admin Tenants ----
  /api/v1/admin/tenants:
    post:
      tags: [admin]
      summary: Create tenant (superadmin only)
      operationId: adminCreateTenant
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminCreateTenantRequest"
      responses:
        "201":
          description: Created tenant
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tenant"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
    get:
      tags: [admin]
      summary: List tenants (superadmin only)
      operationId: adminListTenants
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of tenants
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Tenant"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"

  /api/v1/admin/tenants/{id}:
    patch:
      tags: [admin]
      summary: Update tenant (superadmin only)
      operationId: adminUpdateTenant
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminUpdateTenantRequest"
      responses:
        "200":
          description: Updated tenant
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tenant"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Plan & Usage (tenant-scoped) ----
  /api/v1/plan:
    get:
      tags: [plans]
      summary: Get current tenant plan
      operationId: getTenantPlan
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      responses:
        "200":
          description: Current plan
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantPlanResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/usage/summary:
    get:
      tags: [usage]
      summary: Get today's usage summary
      operationId: getUsageSummary
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      responses:
        "200":
          description: Usage summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsageSummaryResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Admin Plans ----
  /api/v1/admin/plans:
    post:
      tags: [admin]
      summary: Create plan (superadmin only)
      operationId: adminCreatePlan
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePlanRequest"
      responses:
        "201":
          description: Created plan
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Plan"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
    get:
      tags: [admin]
      summary: List plans (superadmin only)
      operationId: adminListPlans
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of plans
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Plan"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/admin/plans/{id}:
    put:
      tags: [admin]
      summary: Update plan (superadmin only)
      operationId: adminUpdatePlan
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePlanRequest"
      responses:
        "200":
          description: Updated plan
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Plan"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/admin/tenants/{tenant_id}/plan:
    post:
      tags: [admin]
      summary: Assign plan to tenant (superadmin only)
      operationId: adminAssignPlan
      security:
        - bearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AssignPlanRequest"
      responses:
        "200":
          description: Plan assigned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantPlanResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Jobs ----
  /api/v1/jobs:
    post:
      tags: [jobs]
      summary: Create job
      operationId: createJob
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateJobRequest"
      responses:
        "201":
          description: Created job
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"
    get:
      tags: [jobs]
      summary: List jobs
      operationId: listJobs
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      responses:
        "200":
          description: List of jobs
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Job"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/jobs/{id}:
    get:
      tags: [jobs]
      summary: Get job
      operationId: getJob
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
    put:
      tags: [jobs]
      summary: Update job
      operationId: updateJob
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateJobRequest"
      responses:
        "200":
          description: Updated job
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Job Versions ----
  /api/v1/jobs/{job_id}/versions:
    post:
      tags: [jobs]
      summary: Create job version (with modules and edges)
      operationId: createJobVersion
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: job_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateJobVersionRequest"
      responses:
        "201":
          description: Created job version
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobVersion"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
    get:
      tags: [jobs]
      summary: List job versions
      operationId: listJobVersions
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: job_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of job versions
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/JobVersion"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/jobs/{job_id}/versions/{version_id}:
    get:
      tags: [jobs]
      summary: Get job version detail (with modules and edges)
      operationId: getJobVersionDetail
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: job_id
          in: path
          required: true
          schema:
            type: string
        - name: version_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job version detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobVersionDetail"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/jobs/{job_id}/versions/{version_id}/publish:
    post:
      tags: [jobs]
      summary: Publish job version
      operationId: publishJobVersion
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: job_id
          in: path
          required: true
          schema:
            type: string
        - name: version_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Published job version
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobVersion"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Job Runs ----
  /api/v1/job_runs:
    get:
      tags: [job_runs]
      summary: List job runs
      operationId: listJobRuns
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
      responses:
        "200":
          description: List of job runs
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/JobRun"
        "401":
          $ref: "#/components/responses/ErrorResponse"
    post:
      tags: [job_runs]
      summary: Create job run
      operationId: createJobRun
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateJobRunRequest"
      responses:
        "201":
          description: Created job run
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobRun"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/job_runs/{id}:
    get:
      tags: [job_runs]
      summary: Get job run by ID
      operationId: getJobRun
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job run detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobRun"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Job Run Modules ----
  /api/v1/job_runs/{job_run_id}/modules:
    get:
      tags: [job_runs]
      summary: List modules for a job run
      operationId: listJobRunModules
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: job_run_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of job run modules
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/JobRunModule"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/job_runs/{job_run_id}/modules/{id}:
    get:
      tags: [job_runs]
      summary: Get job run module detail
      operationId: getJobRunModule
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: job_run_id
          in: path
          required: true
          schema:
            type: string
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job run module detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobRunModule"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Job Run Artifacts ----
  /api/v1/job_runs/{job_run_id}/artifacts:
    get:
      tags: [job_runs]
      summary: List artifacts for a job run
      operationId: listJobRunArtifacts
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: job_run_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of job run artifacts
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/JobRunArtifact"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/job_runs/{job_run_id}/artifacts/{id}:
    get:
      tags: [job_runs]
      summary: Get job run artifact detail
      operationId: getJobRunArtifact
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: job_run_id
          in: path
          required: true
          schema:
            type: string
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job run artifact detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobRunArtifact"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Module Types ----
  /api/v1/module_types:
    post:
      tags: [module_types]
      summary: Create module type
      operationId: createModuleType
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateModuleTypeRequest"
      responses:
        "201":
          description: Created module type
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ModuleType"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"
    get:
      tags: [module_types]
      summary: List module types
      operationId: listModuleTypes
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      responses:
        "200":
          description: List of module types
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/ModuleType"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/module_types/{id}:
    get:
      tags: [module_types]
      summary: Get module type
      operationId: getModuleType
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Module type detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ModuleType"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/module_types/{id}/schemas:
    post:
      tags: [module_types]
      summary: Create module type schema version
      operationId: createModuleTypeSchema
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateModuleTypeSchemaRequest"
      responses:
        "201":
          description: Created module type schema
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ModuleTypeSchema"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
    get:
      tags: [module_types]
      summary: List module type schema versions
      operationId: listModuleTypeSchemas
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of module type schemas
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/ModuleTypeSchema"
        "401":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Connections ----
  /api/v1/connections:
    post:
      tags: [connections]
      summary: Create connection
      operationId: createConnection
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateConnectionRequest"
      responses:
        "201":
          description: Created connection
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Connection"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"
    get:
      tags: [connections]
      summary: List connections
      operationId: listConnections
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      responses:
        "200":
          description: List of connections
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Connection"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/connections/{id}:
    get:
      tags: [connections]
      summary: Get connection
      operationId: getConnection
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Connection detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Connection"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
    put:
      tags: [connections]
      summary: Update connection
      operationId: updateConnection
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateConnectionRequest"
      responses:
        "200":
          description: Updated connection
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Connection"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"
    delete:
      tags: [connections]
      summary: Delete connection
      operationId: deleteConnection
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Datasets ----
  /api/v1/datasets:
    get:
      tags: [datasets]
      summary: List datasets
      operationId: listDatasets
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: q
          in: query
          required: false
          schema:
            type: string
        - name: source_type
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/DatasetSourceType"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
      responses:
        "200":
          description: List of datasets
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Dataset"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/datasets/{id}:
    get:
      tags: [datasets]
      summary: Get dataset
      operationId: getDataset
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Dataset detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Dataset"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /api/v1/datasets/{id}/rows:
    get:
      tags: [datasets]
      summary: Get dataset rows preview
      operationId: getDatasetRows
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 100
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: Dataset rows preview
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DatasetRowsResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Uploads ----
  /api/v1/uploads/presign:
    post:
      tags: [uploads]
      summary: Request presigned upload URLs
      operationId: createUploadPresign
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateUploadPresignRequest"
      responses:
        "201":
          description: Presigned URLs created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateUploadPresignResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "402":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/uploads/{id}/complete:
    post:
      tags: [uploads]
      summary: Mark upload complete
      operationId: completeUpload
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Upload completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Upload"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"

  # ---- Members ----
  /api/v1/tenants/current/members:
    get:
      tags: [members]
      summary: List tenant members
      operationId: listTenantMembers
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      responses:
        "200":
          description: List of tenant members
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/TenantMember"
        "401":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/tenants/current/invitations:
    post:
      tags: [members]
      summary: Create invitation
      operationId: createInvitation
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateInvitationRequest"
      responses:
        "201":
          description: Invitation created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantInvitation"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/tenants/current/invitations/{token}/accept:
    post:
      tags: [members]
      summary: Accept invitation
      operationId: acceptInvitation
      security:
        - bearerAuth: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Invitation accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantInvitation"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"
        "410":
          $ref: "#/components/responses/ErrorResponse"
  /api/v1/tenants/current/members/{user_id}:
    patch:
      tags: [members]
      summary: Update member role
      operationId: updateMemberRole
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: user_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateMemberRoleRequest"
      responses:
        "200":
          description: Role updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantMember"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
    delete:
      tags: [members]
      summary: Remove member
      operationId: removeMember
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantID"
        - name: user_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Member removed
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"

components:
  parameters:
    XTenantID:
      name: X-Tenant-ID
      in: header
      required: true
      schema:
        type: string
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  responses:
    ErrorResponse:
      description: Error response
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
  schemas:
    HealthResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [ok, degraded]
        db:
          type: string
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        display_name:
          type: string
    RegisterResponse:
      type: object
      required: [user_id, tenant_id]
      properties:
        user_id:
          type: string
        tenant_id:
          type: string
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
    LoginResponse:
      type: object
      required: [token]
      properties:
        token:
          type: string
    MeResponse:
      type: object
      required: [user_id, email, display_name, platform_role, tenants]
      properties:
        user_id:
          type: string
        email:
          type: string
          format: email
        display_name:
          type: string
        platform_role:
          type: string
          enum: [user, superadmin]
        tenants:
          type: array
          items:
            $ref: "#/components/schemas/Tenant"
    Tenant:
      type: object
      required: [id, name, is_active]
      properties:
        id:
          type: string
        name:
          type: string
        is_active:
          type: boolean
    AdminCreateTenantRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
    AdminUpdateTenantRequest:
      type: object
      properties:
        name:
          type: string
        is_active:
          type: boolean

    # ---- Event schemas ----
    IngestEventRequest:
      type: object
      required: [event_id, event_name, event_time]
      properties:
        event_id:
          type: string
        event_name:
          type: string
        properties:
          type: object
          additionalProperties: true
        event_time:
          type: string
          format: date-time
    IngestEventResponse:
      type: object
      required: [event_id, status]
      properties:
        event_id:
          type: string
        status:
          type: string
          enum: [accepted]

    # ---- Event summary schemas ----
    EventsSummaryResponse:
      type: object
      required: [counts, total]
      properties:
        counts:
          type: array
          items:
            $ref: "#/components/schemas/EventCount"
        total:
          type: integer
          format: int64
    EventCount:
      type: object
      required: [event_name, count]
      properties:
        event_name:
          type: string
        count:
          type: integer
          format: int64

    # ---- Job schemas ----
    Job:
      type: object
      required: [id, tenant_id, name, slug, is_active]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    CreateJobRequest:
      type: object
      required: [name, slug]
      properties:
        name:
          type: string
        slug:
          type: string
        description:
          type: string
    UpdateJobRequest:
      type: object
      required: [name, slug, is_active]
      properties:
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        is_active:
          type: boolean

    # ---- Job Version schemas ----
    JobVersion:
      type: object
      required: [id, tenant_id, job_id, version, status]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        job_id:
          type: string
        version:
          type: integer
        status:
          type: string
          enum: [draft, published]
        published_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    JobVersionDetail:
      type: object
      required: [version, modules, edges]
      properties:
        version:
          $ref: "#/components/schemas/JobVersion"
        modules:
          type: array
          items:
            $ref: "#/components/schemas/JobModule"
        edges:
          type: array
          items:
            $ref: "#/components/schemas/JobModuleEdge"
    CreateJobVersionRequest:
      type: object
      required: [modules]
      properties:
        modules:
          type: array
          items:
            $ref: "#/components/schemas/CreateJobModuleInput"
        edges:
          type: array
          items:
            $ref: "#/components/schemas/CreateEdgeInput"
    CreateJobModuleInput:
      type: object
      required: [module_type_id, name]
      properties:
        module_type_id:
          type: string
        module_type_schema_id:
          type: string
        connection_id:
          type: string
        name:
          type: string
        config_json:
          type: string
        position_x:
          type: number
        position_y:
          type: number
    CreateEdgeInput:
      type: object
      required: [source_module_index, target_module_index]
      properties:
        source_module_index:
          type: integer
        target_module_index:
          type: integer

    # ---- Job Module schemas ----
    JobModule:
      type: object
      required: [id, tenant_id, job_version_id, module_type_id, name]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        job_version_id:
          type: string
        module_type_id:
          type: string
        module_type_schema_id:
          type: string
        connection_id:
          type: string
        name:
          type: string
        config_json:
          type: string
        position_x:
          type: number
        position_y:
          type: number
    JobModuleEdge:
      type: object
      required: [id, tenant_id, job_version_id, source_module_id, target_module_id]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        job_version_id:
          type: string
        source_module_id:
          type: string
        target_module_id:
          type: string

    # ---- Job Run schemas ----
    CreateJobRunRequest:
      type: object
      required: [job_id]
      properties:
        job_id:
          type: string
        job_version_id:
          type: string
    JobRun:
      type: object
      required: [id, tenant_id, job_id, status]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        job_id:
          type: string
        job_version_id:
          type: string
        status:
          $ref: "#/components/schemas/JobRunStatus"
        started_at:
          type: string
          format: date-time
        finished_at:
          type: string
          format: date-time
    JobRunStatus:
      type: string
      enum: [queued, running, success, failed, canceled]

    # ---- Job Run Module schemas ----
    JobRunModule:
      type: object
      required: [id, tenant_id, job_run_id, job_module_id, status, attempt]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        job_run_id:
          type: string
        job_module_id:
          type: string
        status:
          $ref: "#/components/schemas/JobRunModuleStatus"
        attempt:
          type: integer
        input_json:
          type: string
        output_json:
          type: string
        metrics_json:
          type: string
        error_code:
          type: string
        error_message:
          type: string
        started_at:
          type: string
          format: date-time
        finished_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    JobRunModuleStatus:
      type: string
      enum: [queued, running, success, failed, canceled]

    # ---- Job Run Artifact schemas ----
    JobRunArtifact:
      type: object
      required: [id, tenant_id, job_run_id, name, artifact_type, storage_type, storage_path, size_bytes, content_type]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        job_run_id:
          type: string
        job_run_module_id:
          type: string
        name:
          type: string
        artifact_type:
          type: string
        storage_type:
          type: string
        storage_path:
          type: string
        uri:
          type: string
        size_bytes:
          type: integer
          format: int64
        content_type:
          type: string
        checksum:
          type: string
        metadata_json:
          type: string
        created_at:
          type: string
          format: date-time

    # ---- Module Type schemas ----
    ModuleType:
      type: object
      required: [id, tenant_id, name, category]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        name:
          type: string
        category:
          type: string
          enum: [source, transform, destination]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    CreateModuleTypeRequest:
      type: object
      required: [name, category]
      properties:
        name:
          type: string
        category:
          type: string
          enum: [source, transform, destination]
    ModuleTypeSchema:
      type: object
      required: [id, tenant_id, module_type_id, version, json_schema]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        module_type_id:
          type: string
        version:
          type: integer
        json_schema:
          type: string
        created_at:
          type: string
          format: date-time
    CreateModuleTypeSchemaRequest:
      type: object
      required: [json_schema]
      properties:
        json_schema:
          type: string

    # ---- Connection schemas ----
    Connection:
      type: object
      required: [id, tenant_id, name, type]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        name:
          type: string
        type:
          type: string
        config_json:
          type: string
        secret_ref:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    CreateConnectionRequest:
      type: object
      required: [name, type]
      properties:
        name:
          type: string
        type:
          type: string
        config_json:
          type: string
        secret_ref:
          type: string
    UpdateConnectionRequest:
      type: object
      required: [name, type]
      properties:
        name:
          type: string
        type:
          type: string
        config_json:
          type: string
        secret_ref:
          type: string

    # ---- Dataset schemas ----
    Dataset:
      type: object
      required: [id, tenant_id, name, source_type, storage_path]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        name:
          type: string
        source_type:
          $ref: "#/components/schemas/DatasetSourceType"
        schema_json:
          type: string
        row_count:
          type: integer
          format: int64
        storage_path:
          type: string
        last_updated_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    DatasetSourceType:
      type: string
      enum: [tracker, parquet, import]
    DatasetColumn:
      type: object
      required: [name, type]
      properties:
        name:
          type: string
        type:
          type: string
    DatasetRowsResponse:
      type: object
      required: [columns, rows, total_rows, limit, offset]
      properties:
        columns:
          type: array
          items:
            $ref: "#/components/schemas/DatasetColumn"
        rows:
          type: array
          items:
            type: object
            additionalProperties: true
        total_rows:
          type: integer
          format: int64
        limit:
          type: integer
        offset:
          type: integer

    # ---- Upload schemas ----
    UploadStatus:
      type: string
      enum: [presigned, uploaded]
    UploadFileInput:
      type: object
      required: [filename, content_type, size_bytes]
      properties:
        filename:
          type: string
        content_type:
          type: string
        size_bytes:
          type: integer
          format: int64
    CreateUploadPresignRequest:
      type: object
      required: [files]
      properties:
        files:
          type: array
          items:
            $ref: "#/components/schemas/UploadFileInput"
          minItems: 1
          maxItems: 10
    UploadFilePresigned:
      type: object
      required: [file_id, filename, presigned_url, object_key]
      properties:
        file_id:
          type: string
        filename:
          type: string
        presigned_url:
          type: string
        object_key:
          type: string
        expires_at:
          type: string
          format: date-time
    CreateUploadPresignResponse:
      type: object
      required: [upload_id, files]
      properties:
        upload_id:
          type: string
        files:
          type: array
          items:
            $ref: "#/components/schemas/UploadFilePresigned"
    UploadFile:
      type: object
      required: [id, upload_id, file_name, object_key, content_type, size_bytes]
      properties:
        id:
          type: string
        upload_id:
          type: string
        file_name:
          type: string
        object_key:
          type: string
        content_type:
          type: string
        size_bytes:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
    Upload:
      type: object
      required: [id, tenant_id, status, files]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        status:
          $ref: "#/components/schemas/UploadStatus"
        files:
          type: array
          items:
            $ref: "#/components/schemas/UploadFile"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    # ---- Member schemas ----
    TenantRole:
      type: string
      enum: [owner, admin, member]
    TenantMember:
      type: object
      required: [user_id, email, display_name, role, joined_at]
      properties:
        user_id:
          type: string
        email:
          type: string
          format: email
        display_name:
          type: string
        role:
          $ref: "#/components/schemas/TenantRole"
        joined_at:
          type: string
          format: date-time
    TenantInvitation:
      type: object
      required: [id, tenant_id, email, role, status, created_at]
      properties:
        id:
          type: string
        tenant_id:
          type: string
        email:
          type: string
          format: email
        role:
          $ref: "#/components/schemas/TenantRole"
        token:
          type: string
          description: Invitation token (returned on creation only)
        status:
          type: string
          enum: [pending, accepted, expired]
        invited_by:
          type: string
        expires_at:
          type: string
          format: date-time
        accepted_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
    CreateInvitationRequest:
      type: object
      required: [email, role]
      properties:
        email:
          type: string
          format: email
        role:
          $ref: "#/components/schemas/TenantRole"
    UpdateMemberRoleRequest:
      type: object
      required: [role]
      properties:
        role:
          $ref: "#/components/schemas/TenantRole"

    # ---- Plan & Usage schemas ----
    Plan:
      type: object
      required: [id, name, display_name, max_events_per_day, max_storage_bytes, max_rows_per_day, max_uploads_per_day, is_default]
      properties:
        id:
          type: string
        name:
          type: string
        display_name:
          type: string
        max_events_per_day:
          type: integer
        max_storage_bytes:
          type: integer
          format: int64
        max_rows_per_day:
          type: integer
        max_uploads_per_day:
          type: integer
        is_default:
          type: boolean
    TenantPlanResponse:
      type: object
      required: [plan, started_at]
      properties:
        plan:
          $ref: "#/components/schemas/Plan"
        started_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
    UsageSummaryResponse:
      type: object
      required: [date, events_count, storage_bytes, rows_count, uploads_count]
      properties:
        date:
          type: string
        events_count:
          type: integer
        storage_bytes:
          type: integer
          format: int64
        rows_count:
          type: integer
        uploads_count:
          type: integer
        plan:
          $ref: "#/components/schemas/Plan"
    CreatePlanRequest:
      type: object
      required: [name, display_name]
      properties:
        name:
          type: string
        display_name:
          type: string
        max_events_per_day:
          type: integer
          default: -1
        max_storage_bytes:
          type: integer
          format: int64
          default: -1
        max_rows_per_day:
          type: integer
          default: -1
        max_uploads_per_day:
          type: integer
          default: -1
    UpdatePlanRequest:
      type: object
      properties:
        display_name:
          type: string
        max_events_per_day:
          type: integer
        max_storage_bytes:
          type: integer
          format: int64
        max_rows_per_day:
          type: integer
        max_uploads_per_day:
          type: integer
    AssignPlanRequest:
      type: object
      required: [plan_id]
      properties:
        plan_id:
          type: string
